<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ ç™»éŒ²ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-bg-1: rgba(59, 130, 246, 0.08);
            --color-bg-2: rgba(245, 158, 11, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);
            --color-bg-4: rgba(239, 68, 68, 0.08);
            --color-bg-5: rgba(147, 51, 234, 0.08);
            --color-bg-6: rgba(249, 115, 22, 0.08);
            --color-bg-7: rgba(236, 72, 153, 0.08);
            --color-bg-8: rgba(6, 182, 212, 0.08);
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-info: var(--color-slate-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
            --focus-ring: 0 0 0 3px var(--color-focus-ring);
            --focus-outline: 2px solid var(--color-primary);
            --color-success-rgb: 33, 128, 141;
            --color-error-rgb: 192, 21, 47;
            --color-warning-rgb: 168, 75, 47;
            --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 14px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --font-size-3xl: 24px;
            --font-size-4xl: 30px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            --space-0: 0;
            --space-1: 1px;
            --space-2: 2px;
            --space-4: 4px;
            --space-6: 6px;
            --space-8: 8px;
            --space-10: 10px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-full: 9999px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
            --container-lg: 1024px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-gray-400-rgb: 119, 124, 124;
                --color-teal-300-rgb: 50, 184, 198;
                --color-gray-300-rgb: 167, 169, 169;
                --color-gray-200-rgb: 245, 245, 245;
                --color-bg-1: rgba(29, 78, 216, 0.15);
                --color-bg-2: rgba(180, 83, 9, 0.15);
                --color-bg-3: rgba(21, 128, 61, 0.15);
                --color-bg-4: rgba(185, 28, 28, 0.15);
                --color-bg-5: rgba(107, 33, 168, 0.15);
                --color-bg-6: rgba(194, 65, 12, 0.15);
                --color-bg-7: rgba(190, 24, 93, 0.15);
                --color-bg-8: rgba(8, 145, 178, 0.15);
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
                --color-primary: var(--color-teal-300);
                --color-primary-hover: var(--color-teal-400);
                --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
                --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
                --color-border: rgba(var(--color-gray-400-rgb), 0.3);
                --color-error: var(--color-red-400);
                --color-success: var(--color-teal-300);
                --color-warning: var(--color-orange-400);
                --color-btn-primary-text: var(--color-slate-900);
                --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
                --color-success-rgb: 50, 184, 198;
                --color-error-rgb: 255, 84, 89;
                --color-warning-rgb: 230, 129, 97;
            }
        }

        @font-face {
            font-family: 'FKGroteskNeue';
            src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: var(--font-size-base); font-family: var(--font-family-base); line-height: var(--line-height-normal); color: var(--color-text); background-color: var(--color-background); -webkit-font-smoothing: antialiased; }
        body { margin: 0; padding: var(--space-24); }
        .container { max-width: 700px; margin: 0 auto; }
        h1 { font-size: var(--font-size-3xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-24); color: var(--color-text); }
        h2 { font-size: var(--font-size-2xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-16); color: var(--color-text); }
        h3 { font-size: var(--font-size-lg); font-weight: var(--font-weight-medium); margin-bottom: var(--space-12); color: var(--color-text); }
        
        .tabs { display: flex; gap: var(--space-8); border-bottom: 2px solid var(--color-border); margin-bottom: var(--space-24); overflow-x: auto; }
        .tab { padding: var(--space-12) var(--space-16); background: transparent; border: none; font-size: var(--font-size-md); font-weight: var(--font-weight-medium); color: var(--color-text-secondary); cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all var(--duration-fast) var(--ease-standard); white-space: nowrap; font-family: var(--font-family-base); }
        .tab:hover { color: var(--color-text); background: var(--color-secondary); }
        .tab.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .form-group { margin-bottom: var(--space-16); }
        .form-label { display: block; margin-bottom: var(--space-8); font-weight: var(--font-weight-medium); font-size: var(--font-size-md); color: var(--color-text); }
        .form-label .required { color: var(--color-error); }
        .form-control { display: block; width: 100%; padding: var(--space-12); font-size: var(--font-size-md); line-height: 1.5; color: var(--color-text); background-color: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-base); transition: border-color var(--duration-fast) var(--ease-standard); font-family: var(--font-family-base); }
        .form-control:focus { border-color: var(--color-primary); outline: var(--focus-outline); box-shadow: var(--focus-ring); }
        textarea.form-control { min-height: 100px; resize: vertical; }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: var(--space-12) var(--space-24); border-radius: var(--radius-base); font-size: var(--font-size-md); font-weight: var(--font-weight-medium); line-height: 1.5; cursor: pointer; transition: all var(--duration-normal) var(--ease-standard); border: none; text-decoration: none; font-family: var(--font-family-base); }
        .btn:focus-visible { outline: none; box-shadow: var(--focus-ring); }
        .btn--primary { background: var(--color-primary); color: var(--color-btn-primary-text); }
        .btn--primary:hover { background: var(--color-primary-hover); }
        .btn--secondary { background: var(--color-secondary); color: var(--color-text); border: 1px solid var(--color-border); }
        .btn--secondary:hover { background: var(--color-secondary-hover); }
        .btn--sm { padding: var(--space-6) var(--space-12); font-size: var(--font-size-sm); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .card { background-color: var(--color-surface); border-radius: var(--radius-lg); border: 1px solid var(--color-card-border); padding: var(--space-24); margin-bottom: var(--space-24); box-shadow: var(--shadow-sm); }
        
        .alert { padding: var(--space-16); border-radius: var(--radius-base); margin-bottom: var(--space-16); font-size: var(--font-size-md); display: none; }
        .alert.show { display: block; }
        .alert--success { background-color: rgba(var(--color-success-rgb), 0.15); color: var(--color-success); border: 1px solid rgba(var(--color-success-rgb), 0.25); }
        .alert--error { background-color: rgba(var(--color-error-rgb), 0.15); color: var(--color-error); border: 1px solid rgba(var(--color-error-rgb), 0.25); }
        .alert--warning { background-color: rgba(var(--color-warning-rgb), 0.15); color: var(--color-warning); border: 1px solid rgba(var(--color-warning-rgb), 0.25); }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background-color: var(--color-surface); padding: var(--space-32); border-radius: var(--radius-lg); max-width: 500px; width: 90%; text-align: center; box-shadow: var(--shadow-lg); }
        .modal-content h3 { margin-bottom: var(--space-16); }
        .qr-code-container { margin: var(--space-24) 0; display: flex; justify-content: center; }
        .qr-code-container img { max-width: 100%; border: 2px solid var(--color-border); border-radius: var(--radius-base); }
        .modal-actions { display: flex; gap: var(--space-12); justify-content: center; margin-top: var(--space-24); }
        
        @media print {
            body * { visibility: hidden; }
            .modal-content, .modal-content * { visibility: visible; }
            .modal-content { position: absolute; left: 0; top: 0; }
            .modal-actions { display: none; }
        }
        
        .participant-list { margin-top: var(--space-32); }
        .participant-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-16); background: var(--color-bg-1); border: 1px solid var(--color-card-border); border-radius: var(--radius-base); margin-bottom: var(--space-12); }
        .participant-info { flex: 1; }
        .participant-name { font-weight: var(--font-weight-semibold); font-size: var(--font-size-lg); margin-bottom: var(--space-4); }
        .participant-details { font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-2); }
        .empty-state { text-align: center; padding: var(--space-32); color: var(--color-text-secondary); }
    </style>
</head>
<body>
    <div class="container">
        <!-- Participant Mode (Default) -->
        <div id="participantMode">
            <div style="margin-bottom: var(--space-24);">
                <h1>ğŸ« ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ ç™»éŒ²</h1>
            </div>

            <div class="card">
                <h2>å‚åŠ ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ </h2>
                <p style="margin-bottom: var(--space-24); color: var(--color-text-secondary);">ä»¥ä¸‹ã®æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã€å‚åŠ ç™»éŒ²ã‚’ã—ã¦ãã ã•ã„ã€‚</p>
                <div id="participantAlert" class="alert"></div>
                
                <form id="participantRegistrationForm">
                    <div class="form-group">
                        <label class="form-label" for="participantName">å‚åŠ è€…å <span class="required">*</span></label>
                        <input type="text" id="participantName" class="form-control" required placeholder="å±±ç”°å¤ªéƒ">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="participantEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="required">*</span></label>
                        <input type="email" id="participantEmail" class="form-control" required placeholder="example@email.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="participantGrade">å­¦å¹´ <span class="required">*</span></label>
                        <select id="participantGrade" class="form-control" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="1å¹´">1å¹´</option>
                            <option value="2å¹´">2å¹´</option>
                            <option value="3å¹´">3å¹´</option>
                            <option value="4å¹´">4å¹´</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="participantNotes">å‚™è€ƒ</label>
                        <textarea id="participantNotes" class="form-control" placeholder="ä»»æ„: ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
                    </div>

                    <button type="submit" class="btn btn--primary" style="width: 100%; padding: var(--space-16);">é€ä¿¡</button>
                </form>
            </div>
            
            <div style="margin-top: var(--space-32); padding: var(--space-16); background: var(--color-bg-2); border-radius: var(--radius-base); border: 1px solid var(--color-card-border);">
                <h3>ğŸ“ ç™»éŒ²å¾Œã®æµã‚Œ</h3>
                <ol style="margin-top: var(--space-12); padding-left: var(--space-20); line-height: 1.8; font-size: var(--font-size-sm);">
                    <li>ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã™ã‚‹ã¨ã€QRã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
                    <li>QRã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã¾ãŸã¯å°åˆ·ã—ã¦ãã ã•ã„</li>
                    <li>ã‚¤ãƒ™ãƒ³ãƒˆå½“æ—¥ã€QRã‚³ãƒ¼ãƒ‰ã‚’å—ä»˜ã§æç¤ºã—ã¦ãã ã•ã„</li>
                </ol>
            </div>
            
            <div style="margin-top: var(--space-24); padding: var(--space-12); background: var(--color-bg-8); border-radius: var(--radius-base); border: 1px solid var(--color-card-border); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                ğŸ’¡ <strong>ç®¡ç†è€…ã®æ–¹ã¸:</strong> ç®¡ç†æ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ã€å°‚ç”¨ã®URLã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
            </div>
        </div>

        <!-- Admin Mode (Hidden by default) -->
        <div id="adminMode" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-24); flex-wrap: wrap; gap: var(--space-12);">
                <h1>ğŸ« ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
                <button id="logoutBtn" class="btn btn--secondary btn--sm">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="overview">æ¦‚è¦</button>
                <button class="tab" data-tab="participants">å‚åŠ è€…ä¸€è¦§</button>
                <button class="tab" data-tab="settings">è¨­å®š</button>
            </div>

            <div id="overview" class="tab-content active">
                <div class="card">
                    <h2>ã‚¤ãƒ™ãƒ³ãƒˆçµ±è¨ˆ</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-16);">
                        <div style="background: var(--color-bg-1); padding: var(--space-16); border-radius: var(--radius-base); border: 1px solid var(--color-card-border);">
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--space-4);">ç™»éŒ²è€…æ•°</div>
                            <div style="font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-primary);" id="statsRegistered">0</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>æœ€è¿‘ã®ç™»éŒ²</h2>
                    <div id="recentParticipants" class="empty-state">ç™»éŒ²è€…ãŒã„ã¾ã›ã‚“</div>
                </div>
            </div>

            <div id="participants" class="tab-content">
                <div class="card">
                    <h2>ç™»éŒ²æ¸ˆã¿å‚åŠ è€…</h2>
                    <div id="participantsList" class="empty-state">ã¾ã å‚åŠ è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
                </div>
            </div>

            <div id="settings" class="tab-content">
                <div class="card">
                    <h2>Google Sheets é€£æºè¨­å®š</h2>
                    <p style="margin-bottom: var(--space-16); color: var(--color-text-secondary);">ãƒ‡ãƒ¼ã‚¿ã‚’Google Sheetsã«è‡ªå‹•ä¿å­˜ã™ã‚‹ãŸã‚ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚</p>
                    
                    <div class="form-group">
                        <label class="form-label" for="webAppUrl">Google Sheets Web App URL</label>
                        <input type="url" id="webAppUrl" class="form-control" placeholder="https://script.google.com/macros/s/xxxxx/exec">
                    </div>

                    <button id="saveSettingsBtn" class="btn btn--primary">è¨­å®šã‚’ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3>
            <p style="color: var(--color-text-secondary); margin-bottom: var(--space-16); font-size: var(--font-size-sm);">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
            <div id="loginAlert" class="alert"></div>
            <div class="form-group">
                <label class="form-label" for="adminPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="adminPassword" class="form-control" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
            </div>
            <div class="modal-actions">
                <button id="loginBtn" class="btn btn--primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button id="cancelLoginBtn" class="btn btn--secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <h3>ç™»éŒ²å®Œäº†!</h3>
            <p style="color: var(--color-success); margin-bottom: var(--space-16); font-weight: var(--font-weight-medium);">âœ… ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ!ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
            <div id="modalParticipantName" style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin-bottom: var(--space-4);"></div>
            <div id="modalParticipantId" style="color: var(--color-text-secondary); margin-bottom: var(--space-16); font-size: var(--font-size-sm);"></div>
            <div class="qr-code-container">
                <img id="qrCodeImage" src="" alt="QR Code">
            </div>
            <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-16);">ã‚¤ãƒ™ãƒ³ãƒˆå½“æ—¥ã€ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’å—ä»˜ã§æç¤ºã—ã¦ãã ã•ã„ã€‚</p>
            <div class="modal-actions">
                <button id="printBtn" class="btn btn--primary">å°åˆ·ã™ã‚‹</button>
                <button id="newRegistrationBtn" class="btn btn--secondary">æ–°ã—ã„ç™»éŒ²</button>
                <button id="closeModalBtn" class="btn btn--secondary">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // ADMIN CONFIGURATION - CHANGE THESE!
        // ========================================
        const ADMIN_SECRET_KEY = 'event-admin-xyz123';  // Change this to your own secret key
        const ADMIN_PASSWORD = 'admin2024';              // Change this to your own password
        // ========================================
        let isAdminMode = false;
        let participants = [];
        let googleSheetsUrl = '';

        // Check URL parameters for admin mode
        const urlParams = new URLSearchParams(window.location.search);
        const adminKey = urlParams.get('admin-key');
        
        // Only show password prompt if correct admin-key is provided
        if (adminKey === ADMIN_SECRET_KEY) {
            document.getElementById('adminLoginModal').classList.add('show');
            setTimeout(() => document.getElementById('adminPassword').focus(), 100);
        }

        function generateParticipantId() {
            const now = new Date();
            const timestamp = now.getFullYear().toString() + 
                             (now.getMonth() + 1).toString().padStart(2, '0') + 
                             now.getDate().toString().padStart(2, '0') + 
                             now.getHours().toString().padStart(2, '0') + 
                             now.getMinutes().toString().padStart(2, '0') + 
                             now.getSeconds().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `PARTICIPANT_${timestamp}${random}`;
        }

        function showAlert(alertId, message, type) {
            const alertDiv = document.getElementById(alertId);
            alertDiv.className = `alert alert--${type} show`;
            alertDiv.textContent = message;
            setTimeout(() => alertDiv.classList.remove('show'), 5000);
        }

        document.getElementById('cancelLoginBtn').addEventListener('click', () => {
            document.getElementById('adminLoginModal').classList.remove('show');
            document.getElementById('adminPassword').value = '';
            document.getElementById('loginAlert').classList.remove('show');
        });

        document.getElementById('loginBtn').addEventListener('click', () => {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdminMode = true;
                document.getElementById('adminLoginModal').classList.remove('show');
                document.getElementById('participantMode').style.display = 'none';
                document.getElementById('adminMode').style.display = 'block';
                document.getElementById('adminPassword').value = '';
                document.getElementById('loginAlert').classList.remove('show');
                renderParticipantsList();
                updateStats();
            } else {
                showAlert('loginAlert', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
            }
        });

        document.getElementById('adminPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('loginBtn').click();
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹?')) {
                isAdminMode = false;
                document.getElementById('adminMode').style.display = 'none';
                document.getElementById('participantMode').style.display = 'block';
                // Redirect to participant page without admin-key parameter
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // Participant registration form
        document.getElementById('participantRegistrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('participantName').value.trim();
            const email = document.getElementById('participantEmail').value.trim();
            const grade = document.getElementById('participantGrade').value;
            const notes = document.getElementById('participantNotes').value.trim();

            if (!name || !email || !grade) {
                showAlert('participantAlert', 'ã™ã¹ã¦ã®å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            const participant = { 
                id: generateParticipantId(), 
                name, 
                email, 
                grade, 
                notes, 
                scanned: false,
                timestamp: new Date().toISOString()
            };
            participants.push(participant);
            
            // Send to Google Sheets if configured
            if (googleSheetsUrl) {
                try {
                    await fetch(googleSheetsUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'addParticipant',
                            id: participant.id,
                            name: participant.name,
                            email: participant.email,
                            grade: participant.grade,
                            notes: participant.notes
                        })
                    });
                } catch (error) {
                    console.error('Sync error:', error);
                }
            }
            
            // Show success and QR code
            showAlert('participantAlert', 'ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ!', 'success');
            document.getElementById('participantRegistrationForm').reset();
            
            // Show QR code
            setTimeout(() => {
                showQRCode(participant.id, participant.name);
            }, 500);
        });

        function showQRCode(participantId, participantName) {
            document.getElementById('modalParticipantName').textContent = participantName || '';
            document.getElementById('modalParticipantId').textContent = `ID: ${participantId}`;
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(participantId)}`;
            document.getElementById('qrCodeImage').src = qrCodeUrl;
            document.getElementById('qrModal').classList.add('show');
        }

        document.getElementById('closeModalBtn').addEventListener('click', () => {
            document.getElementById('qrModal').classList.remove('show');
        });

        document.getElementById('newRegistrationBtn').addEventListener('click', () => {
            document.getElementById('qrModal').classList.remove('show');
            document.getElementById('participantName').focus();
        });

        document.getElementById('printBtn').addEventListener('click', () => window.print());

        document.getElementById('qrModal').addEventListener('click', (e) => {
            if (e.target.id === 'qrModal') {
                document.getElementById('qrModal').classList.remove('show');
            }
        });

        document.getElementById('adminLoginModal').addEventListener('click', (e) => {
            if (e.target.id === 'adminLoginModal') {
                document.getElementById('adminLoginModal').classList.remove('show');
            }
        });

        // Tab navigation
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
            });
        });

        function renderParticipantsList() {
            const listContainer = document.getElementById('participantsList');
            const recentContainer = document.getElementById('recentParticipants');
            
            if (participants.length === 0) {
                listContainer.innerHTML = '<div class="empty-state">ã¾ã å‚åŠ è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>';
                if (recentContainer) recentContainer.innerHTML = '<div class="empty-state">ç™»éŒ²è€…ãŒã„ã¾ã›ã‚“</div>';
                return;
            }
            
            const participantsHtml = participants.map(p => `
                <div class="participant-item">
                    <div class="participant-info">
                        <div class="participant-name">${p.name}</div>
                        <div class="participant-details">ID: ${p.id}</div>
                        <div class="participant-details">ãƒ¡ãƒ¼ãƒ«: ${p.email}</div>
                        <div class="participant-details">å­¦å¹´: ${p.grade}</div>
                        ${p.notes ? `<div class="participant-details">å‚™è€ƒ: ${p.notes}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: var(--space-8); flex-direction: column;">
                        <button class="btn btn--secondary btn--sm" onclick="showQRCode('${p.id}', '${p.name}')">QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º</button>
                    </div>
                </div>
            `).join('');
            
            listContainer.innerHTML = participantsHtml;
            
            // Show recent 3 participants
            if (recentContainer) {
                const recent = participants.slice(-3).reverse();
                recentContainer.innerHTML = recent.map(p => `
                    <div class="participant-item">
                        <div class="participant-info">
                            <div class="participant-name">${p.name}</div>
                            <div class="participant-details">${p.grade} - ${p.email}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function updateStats() {
            const statsElement = document.getElementById('statsRegistered');
            if (statsElement) {
                statsElement.textContent = participants.length;
            }
        }

        document.getElementById('saveSettingsBtn').addEventListener('click', () => {
            const url = document.getElementById('webAppUrl').value.trim();
            if (url) {
                googleSheetsUrl = url;
                alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
            } else {
                alert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            }
        });

        // Load saved settings
        const savedUrl = googleSheetsUrl;
        if (savedUrl) {
            document.getElementById('webAppUrl').value = savedUrl;
        }
    </script>
</body>
</html>